<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - CodeArena</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="logo">
            <a href="/" style="text-decoration: none;">
                <strong style="color:#00e6c3">CodeArena</strong>
            </a>
        </div>
        <nav class="nav">
            <a href="/dashboard">Dashboard</a>
            <a href="/marketplace" class="active">Marketplace</a>
            <a href="/quests">Quests</a>
            <a href="/leaderboard">Leaderboard</a>
            <a href="#" onclick="logout()" class="btn-outline">Logout</a>
        </nav>
    </div>
</header>

<main class="container">
    <div class="page-header">
        <h1>Project Marketplace</h1>
        <p>Find exciting projects and start earning</p>
    </div>

    <div class="filters">
        <button class="btn-filter active" onclick="filterProjects('all')">All Projects</button>
        <button class="btn-filter" onclick="filterProjects('OPEN')">Open</button>
        <button class="btn-filter" onclick="filterProjects('ASSIGNED')">Assigned</button>
        <button class="btn-filter" onclick="filterProjects('COMPLETED')">Completed</button>
    </div>

    <div id="projectsList" class="projects-grid">
        <!-- Projects will be loaded here -->
    </div>



     <div class="create-project-section">
         <h2>Have a Project?</h2>
         <button class="btn" onclick="showCreateProjectForm()">Post a Project</button>
     </div>



    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateProjectForm()">&times;</span>
            <h2>Post New Project</h2>
            <form id="createProjectForm">
                <input type="text" name="title" placeholder="Project Title" required>
                <textarea name="description" placeholder="Project Description" required></textarea>
                <input type="number" name="budget" placeholder="cost" step="0.01" required>
                <button type="submit" class="btn">Post Project</button>
            </form>
        </div>
    </div>
</main>

<script>
    async function loadProjects() {
        try {
            const res = await fetch('/api/projects');
            if (res.ok) {
                const projects = await res.json();
                displayProjects(projects);
            }
        } catch (err) {
            console.error('Error loading projects:', err);
        }
    }

    function displayProjects(projects) {
        const container = document.getElementById('projectsList');
        container.innerHTML = '';

        projects.forEach(project => {
            const projectCard = `
                <div class="project-card" data-status="${project.status}">
                    <h3>${project.title}</h3>
                    <p>${project.description}</p>
                    <div class="project-meta">
                        <span class="budget">$${project.budget}</span>
                        <span class="status ${project.status.toLowerCase()}">${project.status}</span>
                    </div>
                    <div class="project-footer">
                        <small>Posted by: ${project.posted_by}</small>
                        ${project.status === 'OPEN' ?
                            `<button class="btn btn-small" onclick="assignProject(${project.P_id})">Apply</button>` :
                            `<small>Assigned to: ${project.assigned_to || 'N/A'}</small>`
                        }
                    </div>
                </div>
            `;
            container.innerHTML += projectCard;
        });
    }

    function filterProjects(status) {
        const cards = document.querySelectorAll('.project-card');
        const buttons = document.querySelectorAll('.btn-filter');

        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        cards.forEach(card => {
            if (status === 'all' || card.dataset.status === status) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    async function assignProject(projectId) {
        const username = prompt('Enter your username to apply:');
        if (username) {
            try {
                const res = await fetch(`/api/projects/${projectId}/assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                if (res.ok) {
                    alert('Project applied successfully!');
                    loadProjects();
                } else {
                    alert('Failed to apply for project');
                }
            } catch (err) {
                console.error('Error applying for project:', err);
            }
        }
    }

    function showCreateProjectForm() {
        document.getElementById('createProjectModal').style.display = 'block';
    }

    function closeCreateProjectForm() {
        document.getElementById('createProjectModal').style.display = 'none';
    }

    document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userResponse = await fetch('/api/auth/current-user');
        const user = await userResponse.json();
        const project = {
            title: formData.get('title'),
            description: formData.get('description'),
            budget: parseFloat(formData.get('budget')),
            posted_by: user.username
        };

        try {
            const res = await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(project)
            });

            if (res.ok) {
                closeCreateProjectForm();
                loadProjects();
                e.target.reset();
            } else {
                alert('Failed to create project');
            }
        } catch (err) {
            console.error('Error creating project:', err);
        }
    });

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        } catch (err) {
            console.error('Error logging out:', err);
        }
    }

    // Load projects when page loads
    loadProjects();
</script>
</body>
</html>